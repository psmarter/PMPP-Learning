# ç¬¬åäºŒç« ï¼šå½’å¹¶

ã€ŠProgramming Massively Parallel Processorsã€‹ç¬¬å››ç‰ˆ - å­¦ä¹ ç¬”è®°ä¸Žç»ƒä¹ 

## ðŸ“š å­¦ä¹ å†…å®¹

æœ¬ç« ç³»ç»Ÿæ¢³ç†å½’å¹¶ï¼ˆMergeï¼‰æ“ä½œåŠå…¶ CUDA ä¼˜åŒ–æŠ€æœ¯ï¼š

- Co-rank å‡½æ•°ï¼ˆäºŒåˆ†æœç´¢å®šä½ï¼‰
- é¡ºåºå½’å¹¶ç®—æ³•
- åŸºç¡€å¹¶è¡Œå½’å¹¶ï¼ˆå…¨å±€å†…å­˜ï¼‰
- åˆ†å—å¹¶è¡Œå½’å¹¶ï¼ˆå…±äº«å†…å­˜ä¼˜åŒ–ï¼‰

**ç›¸å…³åšå®¢ç¬”è®°**ï¼š[ç¬¬åäºŒç« ï¼šå½’å¹¶](https://smarter.xin/posts/31928809/)

---

## ðŸ’» ä»£ç å®žçŽ°

### Exercise01 - å½’å¹¶å®žçŽ°

å®žçŽ°å¤šç§å½’å¹¶ kernelï¼Œå¯¹åº”ä¹¦ä¸­å›¾12.9ã€12.11-12.13ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise01/`

**å®žçŽ°åˆ—è¡¨**ï¼š

| å®žçŽ° | ä¹¦ä¸­å¯¹åº” | ç‰¹ç‚¹ |
| ---- | -------- | ---- |
| `merge_sequential` | - | CPUå‚è€ƒå®žçŽ° |
| `merge_basic_gpu` | å›¾12.9 | åŸºç¡€å¹¶è¡Œï¼Œæ¯çº¿ç¨‹ç‹¬ç«‹ co-rank |
| `merge_tiled_gpu` | å›¾12.11-12.13 | åˆ†å—ä¼˜åŒ–ï¼Œå…±äº«å†…å­˜ |

**æ ¸å¿ƒä»£ç **ï¼š

```cuda
// Co-rank å‡½æ•°æ ¸å¿ƒæ€æƒ³
__host__ __device__ int co_rank(int k, float* A, int m, float* B, int n) {
    int i = min(k, m);
    int j = k - i;
    int i_low = max(0, k - n);
    int j_low = max(0, k - m);

    while (active) {
        if (i > 0 && j < n && A[i-1] > B[j]) {
            // i å¤ªå¤§ï¼Œéœ€è¦å‡å°‘
            delta = cdiv(i - i_low, 2);
            i -= delta; j += delta;
        } else if (j > 0 && i < m && B[j-1] >= A[i]) {
            // i å¤ªå°ï¼Œéœ€è¦å¢žåŠ 
            delta = cdiv(j - j_low, 2);
            i += delta; j -= delta;
        } else {
            break;  // æ‰¾åˆ°æ­£ç¡®ä½ç½®
        }
    }
    return i;
}
```

#### è¿è¡Œ Exercise01

```bash
cd Exercise01
make
make run
```

#### é¢„æœŸè¾“å‡º

```text
================================================================
  ç¬¬åäºŒç« ï¼šå½’å¹¶
  Merge Operations - Multiple Implementations
================================================================

é…ç½®:
  æ•°ç»„ A é•¿åº¦: 10283
  æ•°ç»„ B é•¿åº¦: 131131
  åˆå¹¶ç»“æžœé•¿åº¦: 141414

=== æ­£ç¡®æ€§éªŒè¯ ===

1. CPU é¡ºåºå½’å¹¶... âœ… ç»“æžœæœ‰åº
2. åŸºç¡€å¹¶è¡Œå½’å¹¶ (å›¾12.9)... âœ… ç»“æžœæ­£ç¡®ï¼
3. åˆ†å—å¹¶è¡Œå½’å¹¶ (å›¾12.11-12.13)... âœ… ç»“æžœæ­£ç¡®ï¼
```

---

## ðŸ“– ç»ƒä¹ é¢˜è§£ç­”

### ç»ƒä¹  1

**é¢˜ç›®ï¼š** å‡è®¾éœ€è¦åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨ A=(1, 7, 8, 9, 10) å’Œ B=(7, 10, 10, 12)ã€‚C[8] çš„ååŒæŽ’åï¼ˆco-rankï¼‰å€¼æ˜¯å¤šå°‘ï¼Ÿ

**è§£ç­”ï¼š**

é¦–å…ˆå¾—å‡ºåˆå¹¶ç»“æžœï¼š`[1, 7, 7, 8, 9, 10, 10, 10, 12]`

C[8] = 12ï¼Œè¿™æ˜¯ B ä¸­çš„æœ€åŽä¸€ä¸ªå…ƒç´ ã€‚

æ‰§è¡Œ `co_rank(8, A, 5, B, 4)`ï¼š

```text
åˆå§‹:
  i = min(8, 5) = 5
  j = k - i = 8 - 5 = 3
  i_low = max(0, 8-4) = 4
  j_low = max(0, 8-5) = 3

æ£€æŸ¥æ¡ä»¶:
  i > 0 âœ… && j < n âœ… && A[4]=10 > B[3]=12 âŒ  â†’ ç¬¬ä¸€ä¸ª if ä¸æ»¡è¶³
  j > 0 âœ… && i < m âŒ (5 < 5)                  â†’ ç¬¬äºŒä¸ª if ä¸æ»¡è¶³

ç»“æŸå¾ªçŽ¯ï¼Œè¿”å›ž i = 5
```

ç­”æ¡ˆï¼š**i = 5, j = 3**

è¿™æ„å‘³ç€ C[8:] ä»Ž A[5:] å’Œ B[3:] å¼€å§‹ï¼Œå³ä¸å– A çš„å…ƒç´ ï¼ˆå·²ç”¨å®Œï¼‰ï¼Œåªå– B[3] = 12ã€‚

---

### ç»ƒä¹  2

**é¢˜ç›®ï¼š** å®Œæˆå›¾12.6ä¸­çº¿ç¨‹2çš„ååŒæŽ’åå‡½æ•°è®¡ç®—ã€‚

![Fig. 12.6](exercise2.png)

**è§£ç­”ï¼š**

çº¿ç¨‹2ä»Ž k=6 å¼€å§‹ï¼Œè®¡ç®— `co_rank(6, A, 5, B, 4)`ï¼š

```text
åˆå§‹:
  i = min(6, 5) = 5
  j = k - i = 6 - 5 = 1
  i_low = max(0, 6-4) = 2
  j_low = max(0, 6-5) = 1

æ£€æŸ¥æ¡ä»¶:
  i > 0 âœ… && j < n âœ… && A[4]=10 > B[1]=10 âŒ  â†’ ä¸æ»¡è¶³
  j > 0 âœ… && i < m âŒ                          â†’ ä¸æ»¡è¶³

ç»“æŸå¾ªçŽ¯ï¼Œè¿”å›ž i = 5
```

ç­”æ¡ˆï¼š**i = 5**

è¿™æ„å‘³ç€ C[6:] ä»Ž A å–0ä¸ªå…ƒç´ ï¼ˆå·²ç”¨å®Œï¼‰ï¼Œä»Ž B[1:] å¼€å§‹å–3ä¸ªå…ƒç´ ã€‚

---

### ç»ƒä¹  3

**é¢˜ç›®ï¼š** å¯¹äºŽå›¾12.12ä¸­åŠ è½½ A å’Œ B åˆ†å—çš„ for å¾ªçŽ¯ï¼Œæ·»åŠ  co_rank å‡½æ•°è°ƒç”¨ï¼Œä½¿å¾—åªåŠ è½½å½“å‰ while å¾ªçŽ¯è¿­ä»£ä¸­ä¼šè¢«æ¶ˆè€—çš„ A å’Œ B å…ƒç´ ã€‚

**è§£ç­”ï¼š**

```cpp
while(counter < total_iteration){
    // ç¡®å®šéœ€è¦å¤šå°‘ A å…ƒç´ æ‰èƒ½åˆå¹¶å‡º tile_size ä¸ªç»“æžœ
    int tileA = co_rank(tile_size, 
                        A + A_curr + A_consumed, A_length - A_consumed,
                        B + B_curr + B_consumed, B_length - B_consumed);
    int tileB = tile_size - tileA;

    // åªåŠ è½½éœ€è¦çš„ A å…ƒç´ 
    for(int i = 0; i < tileA; i += blockDim.x) {
        if (i + threadIdx.x < tileA) {
            A_S[i + threadIdx.x] = A[A_curr + A_consumed + i + threadIdx.x];
        }
    }

    // åªåŠ è½½éœ€è¦çš„ B å…ƒç´ 
    for(int i = 0; i < tileB; i += blockDim.x) {
        if(i + threadIdx.x < tileB) {
            B_S[i + threadIdx.x] = B[B_curr + B_consumed + i + threadIdx.x];
        }
    }
    __syncthreads();
```

ä¼˜åŒ–æ•ˆæžœï¼šå‡å°‘ä¸å¿…è¦çš„å…¨å±€å†…å­˜åŠ è½½ã€‚

---

### ç»ƒä¹  4

**é¢˜ç›®ï¼š** è€ƒè™‘å¯¹ä¸¤ä¸ªå¤§å°ä¸º 1,030,400 å’Œ 608,000 çš„æ•°ç»„è¿›è¡Œå¹¶è¡Œå½’å¹¶ã€‚å‡è®¾æ¯ä¸ªçº¿ç¨‹å½’å¹¶8ä¸ªå…ƒç´ ï¼Œå—å¤§å°ä¸º1024ã€‚

ç»“æžœæ•°ç»„é•¿åº¦ï¼š1,030,400 + 608,000 = **1,638,400** å…ƒç´ 

#### a. åŸºç¡€å½’å¹¶ kernelï¼ˆå›¾12.9ï¼‰ä¸­ï¼Œæœ‰å¤šå°‘çº¿ç¨‹åœ¨å…¨å±€å†…å­˜ä¸Šæ‰§è¡ŒäºŒåˆ†æœç´¢ï¼Ÿ

æ¯ä¸ªçº¿ç¨‹å½’å¹¶8ä¸ªå…ƒç´ ï¼Œæ€»å…±éœ€è¦ `1,638,400 / 8 = 204,800` ä¸ªçº¿ç¨‹ã€‚

æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ co_rank ä¸¤æ¬¡ï¼ˆèµ·å§‹å’Œç»“æŸä½ç½®ï¼‰ã€‚

ç­”æ¡ˆï¼š**204,800 ä¸ªçº¿ç¨‹**æ‰§è¡Œå…¨å±€å†…å­˜äºŒåˆ†æœç´¢ã€‚

#### b. åˆ†å—å½’å¹¶ kernelï¼ˆå›¾12.11-12.13ï¼‰ä¸­ï¼Œæœ‰å¤šå°‘çº¿ç¨‹åœ¨å…¨å±€å†…å­˜ä¸Šæ‰§è¡ŒäºŒåˆ†æœç´¢ï¼Ÿ

æ¯ä¸ªå—å¤„ç† `8 Ã— 1024 = 8,192` ä¸ªå…ƒç´ ã€‚

å—æ•°é‡ï¼š`1,638,400 / 8,192 = 200` ä¸ªå—ã€‚

æ¯ä¸ªå—åªæœ‰çº¿ç¨‹0æ‰§è¡Œå…¨å±€å†…å­˜ co_rankï¼ˆä¸¤æ¬¡ï¼‰ï¼Œå…¶ä»–ä½¿ç”¨å…±äº«å†…å­˜ã€‚

ç­”æ¡ˆï¼š**200 ä¸ªçº¿ç¨‹**æ‰§è¡Œå…¨å±€å†…å­˜äºŒåˆ†æœç´¢ã€‚

#### c. åˆ†å—å½’å¹¶ kernel ä¸­ï¼Œæœ‰å¤šå°‘çº¿ç¨‹åœ¨å…±äº«å†…å­˜ä¸Šæ‰§è¡ŒäºŒåˆ†æœç´¢ï¼Ÿ

æ¯ä¸ªå—æœ‰ 1024 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå…±äº«å†…å­˜ co_rank ä¸‰æ¬¡ï¼ˆè¡Œ41ã€43ã€50ï¼‰ã€‚

200 ä¸ªå— Ã— 1024 çº¿ç¨‹ = **204,800 ä¸ªçº¿ç¨‹**æ‰§è¡Œå…±äº«å†…å­˜äºŒåˆ†æœç´¢ã€‚

---

## ðŸ”§ å¼€å‘çŽ¯å¢ƒ

- **CUDA Toolkit**: 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç¼–è¯‘å™¨**: GCC 7.5+ / Visual Studio 2019+ + NVCC
- **GPU**: æ”¯æŒ CUDA çš„ NVIDIA æ˜¾å¡ï¼ˆè®¡ç®—èƒ½åŠ› 3.5+ï¼‰

## ðŸ’¡ å­¦ä¹ å»ºè®®

1. **ç†è§£ co-rank**ï¼šå½’å¹¶çš„å…³é”®æ˜¯æ‰¾åˆ°æ­£ç¡®çš„åˆ†å‰²ç‚¹
2. **äºŒåˆ†æœç´¢**ï¼šO(log n) å¤æ‚åº¦ï¼Œç†è§£è¾¹ç•Œæ¡ä»¶
3. **å…±äº«å†…å­˜ä¼˜åŒ–**ï¼šBlock çº§åˆ«åªéœ€2æ¬¡å…¨å±€ co-rank
4. **è´Ÿè½½å‡è¡¡**ï¼šé€šè¿‡ co-rank å®žçŽ°å‡åŒ€çš„å·¥ä½œåˆ†é…
5. **æ€§èƒ½è°ƒä¼˜å®žè·µ**ï¼šä½¿ç”¨ Nsight Compute åˆ†æžå†…å­˜è®¿é—®æ¨¡å¼ï¼Œå¯¹äºŽä¸åŒå¤§å°çš„è¾“å…¥æ•°ç»„ï¼Œæ¯”è¾ƒåŸºç¡€å½’å¹¶å’Œåˆ†å—å½’å¹¶çš„æ€§èƒ½å·®å¼‚ï¼Œç†è§£ä½•æ—¶å…±äº«å†…å­˜ä¼˜åŒ–æœ€æœ‰æ•ˆ

## ðŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åŽï¼Œç»§ç»­å­¦ä¹ ï¼š

- ç¬¬åä¸‰ç« ï¼šæŽ’åº
- ç¬¬åå››ç« ï¼šç¨€ç–çŸ©é˜µè®¡ç®—
- ç¬¬åäº”ç« ï¼šå›¾éåŽ†

---

## ðŸ“š å‚è€ƒèµ„æ–™

- PMPP ç¬¬å››ç‰ˆ Chapter 12
- [ç¬¬åäºŒç« ï¼šå½’å¹¶](https://smarter.xin/posts/31928809/)

**å­¦ä¹ æ„‰å¿«ï¼** ðŸŽ“
