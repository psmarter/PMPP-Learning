# ç¬¬å…«ç« ï¼šæ¨¡æ¿

ã€ŠProgramming Massively Parallel Processorsã€‹ç¬¬å››ç‰ˆ - å­¦ä¹ ç¬”è®°ä¸ç»ƒä¹ 

## ğŸ“š å­¦ä¹ å†…å®¹

æœ¬ç« ç³»ç»Ÿæ¢³ç†æ¨¡æ¿ï¼ˆStencilï¼‰è®¡ç®—åŠå…¶ CUDA ä¼˜åŒ–æŠ€æœ¯ï¼š

- 3D ä¸ƒç‚¹æ¨¡æ¿è¿ç®—
- å…±äº«å†…å­˜ Tiling
- çº¿ç¨‹ç²—åŒ–ï¼ˆThread Coarseningï¼‰
- å¯„å­˜å™¨ä¼˜åŒ–ï¼ˆRegister Tilingï¼‰
- æ»‘åŠ¨çª—å£æŠ€æœ¯

**ç›¸å…³åšå®¢ç¬”è®°**ï¼š[ç¬¬å…«ç« ï¼šæ¨¡æ¿](https://smarter.xin/posts/93c68d7a/)

---

## åº”ç”¨ç¤ºä¾‹ï¼šçƒ­ä¼ å¯¼ä»¿çœŸ

æ¨¡æ¿è®¡ç®—åœ¨ç‰©ç†ä»¿çœŸä¸­æœ‰å¹¿æ³›åº”ç”¨ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨æœ¬ç«  kernel å®ç°çš„3Dçƒ­ä¼ å¯¼ä»¿çœŸï¼š

![çƒ­ä¼ å¯¼æ–¹ç¨‹3Dä»¿çœŸ](heat_equation_3d.gif)

*ä½¿ç”¨ `stencil_3d_parallel_register_tiling` kernel è®¡ç®—çƒ­é‡éšæ—¶é—´çš„æ‰©æ•£ã€‚*

---

## ğŸ’» ä»£ç å®ç°

### Exercise01 - 3Dæ¨¡æ¿å®ç°

å®ç°5ç§3Dä¸ƒç‚¹æ¨¡æ¿ kernelï¼Œå¯¹åº”ä¹¦ä¸­å›¾8.6ã€8.8ã€8.10ã€8.12ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise01/`

**å®ç°åˆ—è¡¨**ï¼š

| å®ç° | ä¹¦ä¸­å¯¹åº” | ç‰¹ç‚¹ |
| ---- | -------- | ---- |
| `stencil_3d_sequential` | - | CPUå‚è€ƒå®ç° |
| `stencil_3d_parallel_basic` | å›¾8.6 | åŸºç¡€å¹¶è¡Œï¼Œæ— å…±äº«å†…å­˜ |
| `stencil_3d_parallel_shared_memory` | å›¾8.8 | 3Då…±äº«å†…å­˜ Tile |
| `stencil_3d_parallel_thread_coarsening` | å›¾8.10 | Zæ–¹å‘ç²—åŒ–+æ»‘åŠ¨çª—å£ |
| `stencil_3d_parallel_register_tiling` | å›¾8.12 | å¯„å­˜å™¨å­˜Zæ–¹å‘æ•°æ® |

**æ ¸å¿ƒä»£ç **ï¼š

```cuda
// å¯„å­˜å™¨ä¼˜åŒ–æ ¸å¿ƒæ€æƒ³ï¼ˆå›¾8.12ï¼‰
float inPrev, inCurr, inNext;  // Zæ–¹å‘å­˜å¯„å­˜å™¨
__shared__ float inCurr_s[IN_TILE_DIM][IN_TILE_DIM];  // XYå¹³é¢å­˜å…±äº«å†…å­˜

for (int i = iStart; i < iStart + OUT_TILE_DIM; ++i) {
    inNext = in[(i+1) * N * N + j * N + k];
    __syncthreads();
    
    out[i*N*N + j*N + k] = c0 * inCurr +
                           c1 * inCurr_s[ty][tx-1] + c2 * inCurr_s[ty][tx+1] +
                           c3 * inCurr_s[ty-1][tx] + c4 * inCurr_s[ty+1][tx] +
                           c5 * inPrev + c6 * inNext;
    
    // æ»‘åŠ¨çª—å£
    inPrev = inCurr;
    inCurr = inNext;
    inCurr_s[ty][tx] = inNext;
}
```

#### è¿è¡Œ Exercise01

```bash
cd Exercise01
make
make run
```

#### é¢„æœŸè¾“å‡º

```
================================================================
  ç¬¬å…«ç« ï¼šæ¨¡æ¿
  3D Stencil Operations - 5 Implementations
================================================================

é…ç½®:
  ç½‘æ ¼å¤§å°: 64 Ã— 64 Ã— 64
  OUT_TILE_DIM_SMALL: 8, IN_TILE_DIM_SMALL: 10
  OUT_TILE_DIM_BIG: 30, IN_TILE_DIM_BIG: 32

=== æ­£ç¡®æ€§éªŒè¯ ===

1. CPU é¡ºåºå®ç°... å®Œæˆ
2. åŸºç¡€å¹¶è¡Œ (å›¾8.6)... âœ… ç»“æœæ­£ç¡®ï¼
3. å…±äº«å†…å­˜ (å›¾8.8)... âœ… ç»“æœæ­£ç¡®ï¼
4. çº¿ç¨‹ç²—åŒ– (å›¾8.10)... âœ… ç»“æœæ­£ç¡®ï¼
5. å¯„å­˜å™¨ä¼˜åŒ– (å›¾8.12)... âœ… ç»“æœæ­£ç¡®ï¼
```

---

## ğŸ“– ç»ƒä¹ é¢˜è§£ç­”

### ç»ƒä¹  1

**é¢˜ç›®ï¼š** è€ƒè™‘åœ¨ `120 Ã— 120 Ã— 120` ç½‘æ ¼ï¼ˆå«è¾¹ç•Œï¼‰ä¸Šè¿›è¡Œ3Dæ¨¡æ¿è®¡ç®—ã€‚

#### a. æ¯æ¬¡æ¨¡æ¿æ‰«æè®¡ç®—å¤šå°‘ä¸ªè¾“å‡ºç½‘æ ¼ç‚¹ï¼Ÿ

**è§£ç­”ï¼š** è¾¹ç•Œç‚¹ä¸å‚ä¸è®¡ç®—ï¼Œæ‰€ä»¥ï¼š

```
(120 - 2) Ã— (120 - 2) Ã— (120 - 2) = 118 Ã— 118 Ã— 118 = 1,643,032 ä¸ªç‚¹
```

---

#### b. å¯¹äºå›¾8.6çš„åŸºç¡€ kernelï¼Œå‡è®¾å—å¤§å°ä¸º `8 Ã— 8 Ã— 8`ï¼Œéœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹å—ï¼Ÿ

**è§£ç­”ï¼š**

å›¾8.6çš„ kernel ä¸ºæ¯ä¸ªè¾“å…¥ç‚¹å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼š

```cuda
dim3 dimBlock(OUT_TILE_DIM, OUT_TILE_DIM, OUT_TILE_DIM);  // 8Ã—8Ã—8
dim3 dimGrid(cdiv(N, dimBlock.x), cdiv(N, dimBlock.y), cdiv(N, dimBlock.z));
```

```
æ¯ä¸ªç»´åº¦çš„å—æ•° = ceil(120 / 8) = 15
æ€»å—æ•° = 15 Ã— 15 Ã— 15 = 3,375 ä¸ªçº¿ç¨‹å—
```

---

#### c. å¯¹äºå›¾8.8çš„å…±äº«å†…å­˜ kernelï¼Œå‡è®¾å—å¤§å°ä¸º `8 Ã— 8 Ã— 8`ï¼Œéœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹å—ï¼Ÿ

**è§£ç­”ï¼š**

å›¾8.8ä½¿ç”¨å…±äº«å†…å­˜ Tilingï¼š

- `IN_TILE_DIM = 8`ï¼ˆçº¿ç¨‹å—å¤§å°ï¼‰
- `OUT_TILE_DIM = IN_TILE_DIM - 2 = 6`ï¼ˆè¾“å‡º Tile å¤§å°ï¼‰

```cuda
dim3 dimBlock(IN_TILE_DIM, IN_TILE_DIM, IN_TILE_DIM);  // 8Ã—8Ã—8
dim3 dimGrid(cdiv(N, OUT_TILE_DIM), cdiv(N, OUT_TILE_DIM), cdiv(N, OUT_TILE_DIM));
```

```
æ¯ä¸ªç»´åº¦çš„å—æ•° = ceil(120 / 6) = 20
æ€»å—æ•° = 20 Ã— 20 Ã— 20 = 8,000 ä¸ªçº¿ç¨‹å—
```

---

#### d. å¯¹äºå›¾8.10çš„çº¿ç¨‹ç²—åŒ– kernelï¼Œå‡è®¾å—å¤§å°ä¸º `32 Ã— 32`ï¼Œéœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹å—ï¼Ÿ

**è§£ç­”ï¼š**

å›¾8.10ä½¿ç”¨ Z æ–¹å‘ç²—åŒ–ï¼š

- `IN_TILE_DIM = 32`ï¼ˆçº¿ç¨‹å— XY æ–¹å‘å¤§å°ï¼‰
- `OUT_TILE_DIM = IN_TILE_DIM - 2 = 30`
- Z æ–¹å‘ï¼šæ¯ä¸ªå—å¤„ç† `OUT_TILE_DIM = 30` å±‚

```cuda
dim3 dimBlock(IN_TILE_DIM, IN_TILE_DIM, 1);  // 32Ã—32Ã—1
dim3 dimGrid(cdiv(N, OUT_TILE_DIM), cdiv(N, OUT_TILE_DIM), cdiv(N, OUT_TILE_DIM));
```

```
æ¯ä¸ªç»´åº¦çš„å—æ•° = ceil(120 / 30) = 4
æ€»å—æ•° = 4 Ã— 4 Ã— 4 = 64 ä¸ªçº¿ç¨‹å—
```

---

### ç»ƒä¹  2

**é¢˜ç›®ï¼š** è€ƒè™‘ä½¿ç”¨ `32 Ã— 32` çº¿ç¨‹å—å’Œç²—åŒ–å› å­ 16ï¼ˆæ¯ä¸ªå—å¤„ç†Zæ–¹å‘16ä¸ªè¿ç»­è¾“å‡ºå±‚ï¼‰çš„ä¸ƒç‚¹æ¨¡æ¿å®ç°ã€‚

#### a. çº¿ç¨‹å—ç”Ÿå‘½å‘¨æœŸå†…åŠ è½½çš„è¾“å…¥ Tile å¤§å°ï¼ˆå…ƒç´ æ•°ï¼‰ï¼Ÿ

**è§£ç­”ï¼š**

- æ¯å±‚è¾“å…¥ Tile: `IN_TILE_DIM Ã— IN_TILE_DIM = 32 Ã— 32 = 1,024` å…ƒç´ 
- å¤„ç† 16 å±‚è¾“å‡ºéœ€è¦ 18 å±‚è¾“å…¥ï¼ˆå‰åå„ 1 å±‚ haloï¼‰
- æ€»è®¡: `1,024 Ã— 18 = 18,432` å…ƒç´ 

---

#### b. çº¿ç¨‹å—ç”Ÿå‘½å‘¨æœŸå†…å¤„ç†çš„è¾“å‡º Tile å¤§å°ï¼ˆå…ƒç´ æ•°ï¼‰ï¼Ÿ

**è§£ç­”ï¼š**

- æ¯å±‚è¾“å‡º Tile: `OUT_TILE_DIM Ã— OUT_TILE_DIM = 30 Ã— 30 = 900` å…ƒç´ 
- å¤„ç† 16 å±‚
- æ€»è®¡: `900 Ã— 16 = 14,400` å…ƒç´ 

---

#### c. æµ®ç‚¹è¿ç®—ä¸å…¨å±€å†…å­˜è®¿é—®æ¯”ï¼ˆOP/Bï¼‰ï¼Ÿ

**è§£ç­”ï¼š**

- å†…å­˜è¯»å–: `18,432 Ã— 4 = 73,728` å­—èŠ‚
- æ¯ä¸ªè¾“å‡º: 7 æ¬¡ä¹˜æ³• + 6 æ¬¡åŠ æ³• = 13 æ¬¡æµ®ç‚¹è¿ç®—
- æ€»æµ®ç‚¹è¿ç®—: `14,400 Ã— 13 = 187,200` æ¬¡
- æ¯”å€¼: `187,200 / 73,728 = 2.54 OP/B`

*æ³¨ï¼šä»…è®¡ç®—è¯»å–ï¼Œæœªè®¡å…¥å†™å›ã€‚*

---

#### d. ä¸ä½¿ç”¨å¯„å­˜å™¨ Tiling æ—¶ï¼Œæ¯ä¸ªå—éœ€è¦å¤šå°‘å…±äº«å†…å­˜ï¼ˆå­—èŠ‚ï¼‰ï¼Ÿ

**è§£ç­”ï¼š**

éœ€è¦å­˜å‚¨ 3 å±‚ï¼ˆprev/curr/nextï¼‰ï¼š

```
3 Ã— IN_TILE_DIM Ã— IN_TILE_DIM Ã— 4 = 3 Ã— 32 Ã— 32 Ã— 4 = 12,288 å­—èŠ‚
```

---

#### e. ä½¿ç”¨å¯„å­˜å™¨ Tiling æ—¶ï¼Œæ¯ä¸ªå—éœ€è¦å¤šå°‘å…±äº«å†…å­˜ï¼ˆå­—èŠ‚ï¼‰ï¼Ÿ

**è§£ç­”ï¼š**

åªéœ€å­˜å‚¨ 1 å±‚ï¼ˆå½“å‰å±‚çš„ XY å¹³é¢ï¼‰ï¼š

```
IN_TILE_DIM Ã— IN_TILE_DIM Ã— 4 = 32 Ã— 32 Ã— 4 = 4,096 å­—èŠ‚
```

*æ³¨ï¼šZ æ–¹å‘æ•°æ®å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¢åŠ äº†å¯„å­˜å™¨å‹åŠ›ã€‚*

---

## ğŸ”§ å¼€å‘ç¯å¢ƒ

- **CUDA Toolkit**: 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç¼–è¯‘å™¨**: GCC 7.5+ / Visual Studio 2019+ + NVCC
- **GPU**: æ”¯æŒ CUDA çš„ NVIDIA æ˜¾å¡ï¼ˆè®¡ç®—èƒ½åŠ› 3.5+ï¼‰

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ç†è§£ä¸ƒç‚¹æ¨¡æ¿**ï¼šä¸­å¿ƒ + 6 ä¸ªé‚»å±…
2. **å…±äº«å†…å­˜é™åˆ¶**ï¼š3D tile å†…å­˜éœ€æ±‚å¤§
3. **çº¿ç¨‹ç²—åŒ–**ï¼šZæ–¹å‘å±•å¼€å‡å°‘è¾¹ç•Œæµªè´¹
4. **å¯„å­˜å™¨ä¼˜åŒ–**ï¼šæ»‘åŠ¨çª—å£å­˜å¯„å­˜å™¨æ›´å¿«
5. **å¯¹æ¯”æ€§èƒ½**ï¼šä¸åŒå®ç°é€‚åˆä¸åŒé—®é¢˜è§„æ¨¡

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œç»§ç»­å­¦ä¹ ï¼š

- ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾
- ç¬¬åç« ï¼šå½’çº¦
- ç¬¬åä¸€ç« ï¼šå‰ç¼€å’Œ

---

## ğŸ“š å‚è€ƒèµ„æ–™

- PMPP ç¬¬å››ç‰ˆ Chapter 8
- [ç¬¬å…«ç« ï¼šæ¨¡æ¿](https://smarter.xin/posts/93c68d7a/)

**å­¦ä¹ æ„‰å¿«ï¼** ğŸ“
