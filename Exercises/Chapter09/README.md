# ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾

ã€ŠProgramming Massively Parallel Processorsã€‹ç¬¬å››ç‰ˆ - å­¦ä¹ ç¬”è®°ä¸ç»ƒä¹ 

## ğŸ“š å­¦ä¹ å†…å®¹

æœ¬ç« ç³»ç»Ÿæ¢³ç†å¹¶è¡Œç›´æ–¹å›¾è®¡ç®—åŠå…¶ä¼˜åŒ–æŠ€æœ¯ï¼š

- åŸå­æ“ä½œï¼ˆAtomic Operationsï¼‰
- ç§æœ‰åŒ–ï¼ˆPrivatizationï¼‰
- å…±äº«å†…å­˜ä¼˜åŒ–
- çº¿ç¨‹ç²—åŒ–ï¼ˆThread Coarseningï¼‰
- å†…å­˜åˆå¹¶è®¿é—®ï¼ˆCoalesced Memory Accessï¼‰

**ç›¸å…³åšå®¢ç¬”è®°**ï¼š[ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾](https://smarter.xin/posts/d29973f1/)

---

## ğŸ’» ä»£ç å®ç°

### Exercise01 - ç›´æ–¹å›¾å®ç°

å®ç°5ç§ç›´æ–¹å›¾ kernelï¼Œå¯¹åº”ä¹¦ä¸­å›¾9.6ã€9.10ã€9.14ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise01/`

**å®ç°åˆ—è¡¨**ï¼š

| å®ç° | ä¹¦ä¸­å¯¹åº” | ç‰¹ç‚¹ |
| ---- | -------- | ---- |
| `histogram_sequential` | - | CPUå‚è€ƒå®ç° |
| `histogram_parallel_basic` | å›¾9.6 | å…¨å±€å†…å­˜åŸå­æ“ä½œ |
| `histogram_parallel_private_shared` | å›¾9.10 | å…±äº«å†…å­˜ç§æœ‰åŒ– |
| `histogram_parallel_coarsening` | å›¾9.14 | çº¿ç¨‹ç²—åŒ– |
| `histogram_parallel_coalesced` | - | ç²—åŒ– + å†…å­˜åˆå¹¶ |

**æ ¸å¿ƒä»£ç **ï¼š

```cuda
// ç§æœ‰åŒ–æ ¸å¿ƒæ€æƒ³ï¼ˆå›¾9.10ï¼‰
__shared__ unsigned int histo_s[NUM_BINS];  // ç§æœ‰ç›´æ–¹å›¾

// åˆå§‹åŒ–ç§æœ‰ç›´æ–¹å›¾
for (int bin = threadIdx.x; bin < NUM_BINS; bin += blockDim.x) {
    histo_s[bin] = 0u;
}
__syncthreads();

// ç»Ÿè®¡åˆ°ç§æœ‰ç›´æ–¹å›¾ï¼ˆå…±äº«å†…å­˜åŸå­æ“ä½œï¼‰
atomicAdd(&histo_s[alphabet_position / BIN_SIZE], 1);
__syncthreads();

// åˆå¹¶åˆ°å…¨å±€ç›´æ–¹å›¾
atomicAdd(&histo[bin], histo_s[bin]);
```

#### è¿è¡Œ Exercise01

```bash
cd Exercise01
make
make run
```

#### é¢„æœŸè¾“å‡º

```text
================================================================
  ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾
  Histogram Computation - 5 Implementations
================================================================

é…ç½®:
  æ•°æ®é•¿åº¦: 10000000 (10 M)
  BIN_SIZE: 4 (æ¯æ¡¶å­—æ¯æ•°)
  NUM_BINS: 7

=== æ­£ç¡®æ€§éªŒè¯ ===

1. CPU é¡ºåºå®ç°... å®Œæˆ
2. åŸºç¡€å¹¶è¡Œ (å›¾9.6)... âœ… ç»“æœæ­£ç¡®ï¼
3. ç§æœ‰åŒ–å…±äº«å†…å­˜ (å›¾9.10)... âœ… ç»“æœæ­£ç¡®ï¼
4. çº¿ç¨‹ç²—åŒ– (å›¾9.14)... âœ… ç»“æœæ­£ç¡®ï¼
5. çº¿ç¨‹ç²—åŒ– + å†…å­˜åˆå¹¶... âœ… ç»“æœæ­£ç¡®ï¼
```

---

## ğŸ“– ç»ƒä¹ é¢˜è§£ç­”

### ç»ƒä¹  1

**é¢˜ç›®ï¼š** å‡è®¾ DRAM ç³»ç»Ÿä¸­æ¯æ¬¡åŸå­æ“ä½œçš„æ€»å»¶è¿Ÿä¸º 100 nsã€‚å¯¹äºåŒä¸€å…¨å±€å†…å­˜å˜é‡çš„åŸå­æ“ä½œï¼Œæˆ‘ä»¬èƒ½è·å¾—çš„æœ€å¤§ååé‡æ˜¯å¤šå°‘ï¼Ÿ

**è§£ç­”ï¼š**

æ¯æ¬¡æ“ä½œéœ€è¦ 100 nsï¼ˆå³ `100 Ã— 10^-9 s/op`ï¼‰ã€‚ä¸€ç§’å†…å¯ä»¥æ‰§è¡Œï¼š

```text
1s / (100 Ã— 10^-9 s/op) = 10^7 op/s
```

æ‰€ä»¥æœ€å¤§ååé‡æ˜¯ **1000 ä¸‡æ¬¡æ“ä½œ/ç§’**ã€‚

---

### ç»ƒä¹  2

**é¢˜ç›®ï¼š** å¯¹äºæ”¯æŒ L2 ç¼“å­˜åŸå­æ“ä½œçš„å¤„ç†å™¨ï¼Œå‡è®¾æ¯æ¬¡åŸå­æ“ä½œåœ¨ L2 ç¼“å­˜ä¸­éœ€è¦ 4 nsï¼Œåœ¨ DRAM ä¸­éœ€è¦ 100 nsã€‚å‡è®¾ 90% çš„åŸå­æ“ä½œå‘½ä¸­ L2 ç¼“å­˜ã€‚å¯¹äºåŒä¸€å…¨å±€å†…å­˜å˜é‡çš„åŸå­æ“ä½œï¼Œå¤§è‡´ååé‡æ˜¯å¤šå°‘ï¼Ÿ

**è§£ç­”ï¼š**

å¹³å‡æ¯æ¬¡æ“ä½œè€—æ—¶ï¼š

```text
0.9 Ã— 4 ns + 0.1 Ã— 100 ns = 3.6 ns + 10 ns = 13.6 ns
```

ååé‡ï¼š

```text
1s / (13.6 Ã— 10^-9 s/op) â‰ˆ 73.5 Ã— 10^6 op/s
```

æ‰€ä»¥ååé‡çº¦ä¸º **7350 ä¸‡æ¬¡æ“ä½œ/ç§’**ã€‚

*æ³¨ï¼šç”±äºæ“ä½œçš„æ˜¯åŒä¸€å…¨å±€å˜é‡ï¼Œè¿™äº›åŸå­æ“ä½œå¿…é¡»ä¸²è¡Œæ‰§è¡Œã€‚*

---

### ç»ƒä¹  3

**é¢˜ç›®ï¼š** åœ¨ç»ƒä¹  1 ä¸­ï¼Œå‡è®¾ kernel æ¯æ¬¡åŸå­æ“ä½œæ‰§è¡Œ 5 æ¬¡æµ®ç‚¹è¿ç®—ã€‚å—åŸå­æ“ä½œååé‡é™åˆ¶ï¼Œkernel æ‰§è¡Œçš„æœ€å¤§æµ®ç‚¹ååé‡æ˜¯å¤šå°‘ï¼Ÿ

**è§£ç­”ï¼š**

æ ¹æ®ç»ƒä¹  1ï¼ŒåŸå­æ“ä½œååé‡ä¸º 1000 ä¸‡æ¬¡/ç§’ã€‚æµ®ç‚¹ååé‡ï¼š

```text
(5 FP ops/Atomic op) Ã— (10^7 Atomic ops/s) = 5 Ã— 10^7 FLOPS = 50 MFLOPS
```

è¿™è¿œä½äºç°ä»£ GPU çš„æµ®ç‚¹æ€§èƒ½ï¼ˆé€šå¸¸æ˜¯ TFLOPS çº§åˆ«ï¼‰ï¼Œç›¸å·®å¤šä¸ªæ•°é‡çº§ã€‚

---

### ç»ƒä¹  4

**é¢˜ç›®ï¼š** åœ¨ç»ƒä¹  1 ä¸­ï¼Œå‡è®¾æˆ‘ä»¬å°†å…¨å±€å†…å­˜å˜é‡ç§æœ‰åŒ–åˆ°å…±äº«å†…å­˜ï¼Œå…±äº«å†…å­˜è®¿é—®å»¶è¿Ÿä¸º 1 nsã€‚æ‰€æœ‰åŸæ¥çš„å…¨å±€å†…å­˜åŸå­æ“ä½œéƒ½è½¬æ¢ä¸ºå…±äº«å†…å­˜åŸå­æ“ä½œã€‚å‡è®¾å°†ç§æœ‰åŒ–å˜é‡ç´¯åŠ åˆ°å…¨å±€å˜é‡çš„é¢å¤–å…¨å±€å†…å­˜åŸå­æ“ä½œå¢åŠ äº† 10% çš„æ€»æ‰§è¡Œæ—¶é—´ã€‚å‡è®¾ kernel æ¯æ¬¡åŸå­æ“ä½œæ‰§è¡Œ 5 æ¬¡æµ®ç‚¹è¿ç®—ã€‚å—åŸå­æ“ä½œååé‡é™åˆ¶ï¼Œæœ€å¤§æµ®ç‚¹ååé‡æ˜¯å¤šå°‘ï¼Ÿ

**è§£ç­”ï¼š**

å…±äº«å†…å­˜åŸå­æ“ä½œååé‡ï¼š

```text
1s / (1 ns/op Ã— 1.1) = 1s / (1.1 Ã— 10^-9 s/op) â‰ˆ 9.1 Ã— 10^8 op/s
```

æµ®ç‚¹ååé‡ï¼š

```text
5 Ã— 9.1 Ã— 10^8 = 4.55 Ã— 10^9 FLOPS = 4.55 GFLOPS
```

è™½ç„¶æ¯”ç»ƒä¹  3 æé«˜äº†çº¦ 90 å€ï¼Œä½†ä»æ¯” H100 ç­‰ç°ä»£ GPU çš„ç†è®ºå³°å€¼ï¼ˆçº¦æ•°å TFLOPSï¼‰ä½çº¦ 5 ä¸ªæ•°é‡çº§ã€‚

---

### ç»ƒä¹  5

**é¢˜ç›®ï¼š** è¦æ‰§è¡ŒåŸå­åŠ æ“ä½œï¼Œå°†æ•´æ•°å˜é‡ Partial çš„å€¼åŠ åˆ°å…¨å±€å†…å­˜æ•´æ•°å˜é‡ Totalï¼Œåº”è¯¥ä½¿ç”¨ä»¥ä¸‹å“ªä¸ªè¯­å¥ï¼Ÿ

**a.** `atomicAdd(Total, 1);`  
**b.** `atomicAdd(&Total, &Partial);`  
**c.** `atomicAdd(Total, &Partial);`  
**d.** `atomicAdd(&Total, Partial);`  

**è§£ç­”ï¼š**

`atomicAdd` çš„å‡½æ•°ç­¾åæ˜¯ï¼š

```cpp
int atomicAdd(int* address, int val);
```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦æ›´æ–°çš„å˜é‡çš„**åœ°å€**ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦åŠ çš„**å€¼**ã€‚

ç­”æ¡ˆæ˜¯ **D** â€” `atomicAdd(&Total, Partial)`ï¼Œå³ `Total` çš„åœ°å€å’Œ `Partial` çš„å€¼ã€‚

---

### ç»ƒä¹  6

**é¢˜ç›®ï¼š** è€ƒè™‘ä¸€ä¸ªç›´æ–¹å›¾ kernelï¼Œå¤„ç† 524,288 ä¸ªå…ƒç´ çš„è¾“å…¥ï¼Œäº§ç”Ÿ 128 ä¸ªæ¡¶çš„ç›´æ–¹å›¾ã€‚kernel é…ç½®ä¸ºæ¯ä¸ªå— 1024 ä¸ªçº¿ç¨‹ã€‚

#### a. å›¾9.6 çš„ kernelï¼ˆæ— ç§æœ‰åŒ–ã€å…±äº«å†…å­˜å’Œçº¿ç¨‹ç²—åŒ–ï¼‰åœ¨å…¨å±€å†…å­˜ä¸Šæ‰§è¡Œå¤šå°‘æ¬¡åŸå­æ“ä½œï¼Ÿ

**è§£ç­”ï¼š**

åœ¨å›¾9.6 çš„ kernel ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹å…¨å±€å†…å­˜æ‰§è¡Œä¸€æ¬¡ `atomicAdd`ï¼ˆç¬¬06è¡Œï¼‰ã€‚ç”±äºå¯åŠ¨äº† 524,288 ä¸ªçº¿ç¨‹ï¼Œå…¨å±€å†…å­˜åŸå­æ“ä½œæ¬¡æ•°ä¸º **524,288 æ¬¡**ã€‚

---

#### b. å›¾9.10 çš„ kernelï¼ˆä½¿ç”¨ç§æœ‰åŒ–å’Œå…±äº«å†…å­˜ï¼Œæ— çº¿ç¨‹ç²—åŒ–ï¼‰åœ¨å…¨å±€å†…å­˜ä¸Šæœ€å¤šæ‰§è¡Œå¤šå°‘æ¬¡åŸå­æ“ä½œï¼Ÿ

**è§£ç­”ï¼š**

åœ¨å›¾9.10 ä¸­ï¼Œåªæœ‰åœ¨å°†å…±äº«å†…å­˜ç§æœ‰ç›´æ–¹å›¾åˆå¹¶åˆ°å…¨å±€å†…å­˜æ—¶æ‰æ‰§è¡Œå…¨å±€åŸå­æ“ä½œã€‚æ¯ä¸ª Block å¯¹æ¯ä¸ªæ¡¶æ‰§è¡Œä¸€æ¬¡ `atomicAdd`ï¼ˆå¦‚æœ `threadIdx.x < NUM_BINS`ï¼‰ï¼Œå³æ¯ä¸ª Block æœ€å¤š 128 æ¬¡ã€‚

Block æ•°é‡ï¼š

```text
(524,288 + 1024 - 1) / 1024 = 512 ä¸ª Block
```

å…¨å±€å†…å­˜åŸå­æ“ä½œæ¬¡æ•°ï¼š

```text
512 Ã— 128 = 65,536 æ¬¡
```

---

#### c. å›¾9.14 çš„ kernelï¼ˆä½¿ç”¨ç§æœ‰åŒ–ã€å…±äº«å†…å­˜å’Œç²—åŒ–å› å­ 4ï¼‰åœ¨å…¨å±€å†…å­˜ä¸Šæœ€å¤šæ‰§è¡Œå¤šå°‘æ¬¡åŸå­æ“ä½œï¼Ÿ

**è§£ç­”ï¼š**

ä½¿ç”¨ç²—åŒ–å› å­ 4 åï¼ŒBlock æ•°é‡å‡å°‘ï¼š

```text
512 / 4 = 128 ä¸ª Block
```

åˆå¹¶æœºåˆ¶ä¸å˜ï¼ˆæ¯ä¸ª Block å¯¹æ¯ä¸ªæ¡¶æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå…¨å±€å†…å­˜åŸå­æ“ä½œæ¬¡æ•°ï¼š

```text
128 Ã— 128 = 16,384 æ¬¡
```

---

## ğŸ”§ å¼€å‘ç¯å¢ƒ

- **CUDA Toolkit**: 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç¼–è¯‘å™¨**: GCC 7.5+ / Visual Studio 2019+ + NVCC
- **GPU**: æ”¯æŒ CUDA çš„ NVIDIA æ˜¾å¡ï¼ˆè®¡ç®—èƒ½åŠ› 3.5+ï¼‰

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ç†è§£åŸå­æ“ä½œ**ï¼šè¯»-æ”¹-å†™çš„åŸå­æ€§
2. **ç§æœ‰åŒ–ç­–ç•¥**ï¼šå‡å°‘äº‰ç”¨æ˜¯å…³é”®
3. **å…±äº«å†…å­˜ vs å…¨å±€å†…å­˜**ï¼šåŸå­æ“ä½œæ€§èƒ½å·® ~20 å€
4. **çº¿ç¨‹ç²—åŒ–**ï¼šå‡å°‘ Block æ•°é‡å’Œåˆå¹¶å¼€é”€
5. **å†…å­˜åˆå¹¶**ï¼šGrid-Stride Loop æ˜¯é€šç”¨ä¼˜åŒ–æ¨¡å¼

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œç»§ç»­å­¦ä¹ ï¼š

- ç¬¬åç« ï¼šå½’çº¦
- ç¬¬åä¸€ç« ï¼šå‰ç¼€å’Œ
- ç¬¬åäºŒç« ï¼šåˆå¹¶

---

## ğŸ“š å‚è€ƒèµ„æ–™

- PMPP ç¬¬å››ç‰ˆ Chapter 9
- [ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾](https://smarter.xin/posts/d29973f1/)

**å­¦ä¹ æ„‰å¿«ï¼** ğŸ“
