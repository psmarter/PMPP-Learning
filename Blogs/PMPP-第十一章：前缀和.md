---
title: PMPP-ç¬¬åä¸€ç« ï¼šå‰ç¼€å’Œ
tags:
  - CUDA
  - GPUç¼–ç¨‹
  - å¹¶è¡Œè®¡ç®—
  - PMPP
  - å‰ç¼€å’Œ
  - Scan
  - å·¥ä½œæ•ˆç‡
categories: çŸ¥è¯†åˆ†äº«
cover: /img/PMPP.jpg
abbrlink: a6fc4cf6
date: 2026-01-18 15:51:17
---

## å‰è¨€

ç¬¬åç« å­¦ä¹ äº†å½’çº¦â€”â€”æŠŠ N ä¸ªæ•°å½’çº¦æˆ 1 ä¸ªæ•°ã€‚æœ¬ç« å­¦ä¹ **å‰ç¼€å’Œï¼ˆPrefix Sumï¼‰**ï¼Œä¹Ÿç§°ä¸º **Scan**â€”â€”æŠŠ N ä¸ªæ•°å˜æ¢æˆ N ä¸ªæ•°ï¼Œæ¯ä¸ªä½ç½®å­˜å‚¨ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„ç´¯è®¡ç»“æœã€‚è™½ç„¶çœ‹èµ·æ¥è®¡ç®—é‡æ›´å¤§ï¼Œä½†å‰ç¼€å’Œæ˜¯å¹¶è¡Œè®¡ç®—çš„"ç‘å£«å†›åˆ€"ï¼Œèƒ½è§£å†³è®¸å¤šçœ‹ä¼¼æ— æ³•å¹¶è¡Œçš„é—®é¢˜ï¼šæµå‹ç¼©ã€åŸºæ•°æ’åºã€ç¨€ç–çŸ©é˜µè¿ç®—ç­‰ã€‚ç¬¬åä¸€ç« é‡ç‚¹è®²è§£**å·¥ä½œæ•ˆç‡ï¼ˆWork Efficiencyï¼‰**çš„æ¦‚å¿µâ€”â€”å¦‚ä½•è®©å¹¶è¡Œç®—æ³•çš„æ€»å·¥ä½œé‡ä¸è¶…è¿‡ä¸²è¡Œç®—æ³•å¤ªå¤šã€‚

> **ğŸ“¦ é…å¥—èµ„æº**ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ [GitHub ä»“åº“](https://github.com/psmarter/PMPP-Learning)ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚

## å‰ç¼€å’ŒåŸºç¡€

### ä»€ä¹ˆæ˜¯å‰ç¼€å’Œ

**å‰ç¼€å’Œ**ï¼šå¯¹äºè¾“å…¥æ•°ç»„ `[aâ‚€, aâ‚, aâ‚‚, ..., aâ‚™â‚‹â‚]`ï¼Œè¾“å‡ºæ¯ä¸ªä½ç½®ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„ç´¯è®¡å€¼ã€‚

æœ‰ä¸¤ç§å˜ä½“ï¼š

**åŒ…å«å¼æ‰«æï¼ˆInclusive Scanï¼‰**ï¼šåŒ…å«å½“å‰å…ƒç´ 

```
è¾“å…¥:  [3, 1, 7, 0, 4, 1, 6, 3]
è¾“å‡º:  [3, 4, 11, 11, 15, 16, 22, 25]
       3  3+1  4+7  11+0  ...
```

**æ’é™¤å¼æ‰«æï¼ˆExclusive Scanï¼‰**ï¼šä¸åŒ…å«å½“å‰å…ƒç´ 

```
è¾“å…¥:  [3, 1, 7, 0, 4, 1, 6, 3]
è¾“å‡º:  [0, 3, 4, 11, 11, 15, 16, 22]
       0  å‰ç¼€  å‰ç¼€+1  å‰ç¼€+7  ...
```

**å…³ç³»**ï¼š`exclusive[i] = inclusive[i-1]`ï¼Œ`exclusive[0] = 0`

### æ•°å­¦å®šä¹‰

å¯¹äºäºŒå…ƒç»“åˆè¿ç®— âŠ•ï¼š

**Inclusive Scan**:
$$
y_i = \bigoplus_{j=0}^{i} x_j = x_0 \oplus x_1 \oplus ... \oplus x_i
$$

**Exclusive Scan**:
$$
y_i = \bigoplus_{j=0}^{i-1} x_j = x_0 \oplus x_1 \oplus ... \oplus x_{i-1}
$$

å…¶ä¸­ `yâ‚€ = identity`ï¼ˆå•ä½å…ƒï¼‰ã€‚

### åº”ç”¨åœºæ™¯

å‰ç¼€å’Œç”¨é€”æå¹¿ï¼š

| åº”ç”¨               | è¯´æ˜                 |
| ------------------ | -------------------- |
| **æµå‹ç¼©**         | æ ¹æ®æ¡ä»¶ç­›é€‰å…ƒç´      |
| **åŸºæ•°æ’åº**       | è®¡ç®—æ¯ä¸ªæ¡¶çš„èµ·å§‹ä½ç½® |
| **ç¨€ç–çŸ©é˜µ**       | CSR æ ¼å¼çš„è¡ŒæŒ‡é’ˆæ•°ç»„ |
| **å¤šé¡¹å¼æ±‚å€¼**     | Horner æ³•åˆ™çš„å¹¶è¡ŒåŒ–  |
| **æ±‚è§£ä¸‰å¯¹è§’æ–¹ç¨‹** | å¾ªç¯å½’çº¦             |
| **ç›´æ–¹å›¾å‡è¡¡åŒ–**   | ç´¯ç§¯åˆ†å¸ƒå‡½æ•°         |

**æ ¸å¿ƒæ€æƒ³**ï¼šå‰ç¼€å’ŒæŠŠ"ä¾èµ–å‰é¢ç»“æœ"çš„é—®é¢˜è½¬åŒ–ä¸ºå¯å¹¶è¡Œçš„å½¢å¼ã€‚

### ä¸²è¡Œå®ç°

```c
void inclusive_scan_sequential(float *x, float *y, int n) {
    y[0] = x[0];
    for (int i = 1; i < n; i++) {
        y[i] = y[i-1] + x[i];
    }
}
```

æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œå­˜åœ¨ä¸¥æ ¼çš„æ•°æ®ä¾èµ–ï¼š`y[i]` ä¾èµ– `y[i-1]`ã€‚

çœ‹ä¼¼æ— æ³•å¹¶è¡Œï¼Ÿå…¶å®å¯ä»¥ï¼

## Kogge-Stone ç®—æ³•

### æ ¸å¿ƒæ€æƒ³

åˆ©ç”¨ç»“åˆå¾‹ï¼Œä¸éœ€è¦æŒ‰é¡ºåºè®¡ç®—ï¼š

```
y[i] = x[0] + x[1] + ... + x[i]
     = (x[0] + x[1] + ... + x[i-k]) + (x[i-k+1] + ... + x[i])
```

**æ€è·¯**ï¼šæ¯ä¸€æ­¥è®©æ¯ä¸ªå…ƒç´ ä¸è·ç¦»ä¸º 2^k çš„å…ƒç´ ç›¸åŠ ã€‚

### ç®—æ³•è¿‡ç¨‹

```
åˆå§‹:     [3, 1, 7, 0, 4, 1, 6, 3]

Step 1 (stride=1):
  y[i] = x[i] + x[i-1]
  ç»“æœ: [3, 4, 8, 7, 4, 5, 7, 9]

Step 2 (stride=2):
  y[i] = y[i] + y[i-2]
  ç»“æœ: [3, 4, 11, 11, 12, 12, 11, 14]

Step 3 (stride=4):
  y[i] = y[i] + y[i-4]
  ç»“æœ: [3, 4, 11, 11, 15, 16, 22, 25]

å®Œæˆï¼
```

æ¯ä¸€æ­¥ï¼Œæ¯ä¸ªå…ƒç´ éƒ½å¹¶è¡Œæ›´æ–°ã€‚logâ‚‚N æ­¥åå®Œæˆã€‚

### CUDA å®ç°

```cuda
__global__ void kogge_stone_scan(float *X, float *Y, int n) {
    __shared__ float XY[SECTION_SIZE];
    
    int i = blockIdx.x * blockDim.x + threadIdx.x;
    
    // åŠ è½½åˆ°å…±äº«å†…å­˜
    if (i < n) {
        XY[threadIdx.x] = X[i];
    } else {
        XY[threadIdx.x] = 0;
    }
    
    // Kogge-Stone æ‰«æ
    for (unsigned int stride = 1; stride < blockDim.x; stride *= 2) {
        __syncthreads();
        float temp;
        if (threadIdx.x >= stride) {
            temp = XY[threadIdx.x] + XY[threadIdx.x - stride];
        }
        __syncthreads();
        if (threadIdx.x >= stride) {
            XY[threadIdx.x] = temp;
        }
    }
    
    // å†™å›
    if (i < n) {
        Y[i] = XY[threadIdx.x];
    }
}
```

### ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡åŒæ­¥ï¼Ÿ

```cuda
__syncthreads();  // ç¬¬ä¸€æ¬¡ï¼šç¡®ä¿æ‰€æœ‰çº¿ç¨‹è¯»å®Œ
temp = XY[...] + XY[...];  // è¯»å–
__syncthreads();  // ç¬¬äºŒæ¬¡ï¼šç¡®ä¿æ‰€æœ‰çº¿ç¨‹è¯»å®Œå†å†™
XY[...] = temp;  // å†™å…¥
```

å¦‚æœä¸ç”¨ä¸´æ—¶å˜é‡ï¼š

```cuda
// é”™è¯¯ï¼
XY[i] = XY[i] + XY[i-stride];  // å¦‚æœé‚»å±…è¿˜æ²¡è¯»å®Œå°±è¢«è¦†ç›–
```

**å…³é”®**ï¼šè¯»å’Œå†™å¿…é¡»åˆ†ç¦»ï¼Œç”¨åŒæ­¥ä¿è¯ã€‚

### å·¥ä½œé‡åˆ†æ

| æŒ‡æ ‡     | ä¸²è¡Œç®—æ³• | Kogge-Stone |
| -------- | -------- | ----------- |
| æ­¥æ•°     | N        | logâ‚‚N       |
| æ¯æ­¥æ“ä½œ | 1        | ~N          |
| æ€»æ“ä½œ   | N        | NÂ·logâ‚‚N     |

**é—®é¢˜**ï¼šKogge-Stone åšäº†æ›´å¤šçš„å·¥ä½œï¼

å¯¹äº N=1024ï¼š

- ä¸²è¡Œï¼š1024 æ¬¡æ“ä½œ
- Kogge-Stoneï¼š1024 Ã— 10 = 10240 æ¬¡æ“ä½œ

è¿™å°±æ˜¯**å·¥ä½œæ•ˆç‡ï¼ˆWork Efficiencyï¼‰**é—®é¢˜ã€‚

## Brent-Kung ç®—æ³•

### å·¥ä½œæ•ˆç‡ä¼˜åŒ–

**æ€è·¯**ï¼šå‡å°‘å†—ä½™è®¡ç®—ï¼Œåˆ†ä¸¤ä¸ªé˜¶æ®µï¼š

1. **å½’çº¦é˜¶æ®µï¼ˆReduceï¼‰**ï¼šè‡ªåº•å‘ä¸Šï¼Œæ„å»ºéƒ¨åˆ†å’Œ
2. **åˆ†å‘é˜¶æ®µï¼ˆDownsweepï¼‰**ï¼šè‡ªé¡¶å‘ä¸‹ï¼Œåˆ†å‘ç»“æœ

### ç®—æ³•è¿‡ç¨‹

**é˜¶æ®µ 1ï¼šå½’çº¦**

```
åˆå§‹:     [3, 1, 7, 0, 4, 1, 6, 3]

Step 1 (stride=1): ç›¸é‚»å…ƒç´ é…å¯¹æ±‚å’Œ
          [3, 4, 7, 7, 4, 5, 6, 9]
              â†‘     â†‘     â†‘     â†‘
             1+3   0+7   1+4   3+6

Step 2 (stride=2): éš”ä¸€ä¸ªé…å¯¹
          [3, 4, 7, 11, 4, 5, 6, 14]
                   â†‘           â†‘
                  4+7         5+9

Step 3 (stride=4): éš”ä¸‰ä¸ªé…å¯¹
          [3, 4, 7, 11, 4, 5, 6, 25]
                               â†‘
                             11+14
```

ç°åœ¨ `XY[7] = 25 = å…¨éƒ¨å…ƒç´ ä¹‹å’Œ`ã€‚

**é˜¶æ®µ 2ï¼šåˆ†å‘ï¼ˆDownsweepï¼‰**

```
ä»å³åˆ°å·¦ï¼ŒæŠŠéƒ¨åˆ†å’Œ"ä¼ æ’­"ä¸‹å»ï¼š

Step 1 (stride=2):
  XY[5] = XY[5] + XY[3] = 5 + 11 = 16
          [3, 4, 7, 11, 4, 16, 6, 25]

Step 2 (stride=1):
  XY[2] = XY[2] + XY[1] = 7 + 4 = 11
  XY[4] = XY[4] + XY[3] = 4 + 11 = 15
  XY[6] = XY[6] + XY[5] = 6 + 16 = 22
          [3, 4, 11, 11, 15, 16, 22, 25]

å®Œæˆï¼
```

### CUDA å®ç°

```cuda
__global__ void brent_kung_scan(float *X, float *Y, int n) {
    __shared__ float XY[SECTION_SIZE];
    
    int i = 2 * blockIdx.x * blockDim.x + threadIdx.x;
    
    // åŠ è½½ï¼ˆæ¯çº¿ç¨‹ä¸¤ä¸ªå…ƒç´ ï¼‰
    if (i < n) XY[threadIdx.x] = X[i];
    if (i + blockDim.x < n) XY[threadIdx.x + blockDim.x] = X[i + blockDim.x];
    
    // ========== å½’çº¦é˜¶æ®µ ==========
    for (unsigned int stride = 1; stride <= blockDim.x; stride *= 2) {
        __syncthreads();
        int index = (threadIdx.x + 1) * 2 * stride - 1;
        if (index < SECTION_SIZE) {
            XY[index] += XY[index - stride];
        }
    }
    
    // ========== åˆ†å‘é˜¶æ®µ ==========
    for (unsigned int stride = SECTION_SIZE / 4; stride > 0; stride /= 2) {
        __syncthreads();
        int index = (threadIdx.x + 1) * 2 * stride - 1;
        if (index + stride < SECTION_SIZE) {
            XY[index + stride] += XY[index];
        }
    }
    
    __syncthreads();
    
    // å†™å›
    if (i < n) Y[i] = XY[threadIdx.x];
    if (i + blockDim.x < n) Y[i + blockDim.x] = XY[threadIdx.x + blockDim.x];
}
```

### å·¥ä½œé‡åˆ†æ

| é˜¶æ®µ     | æ­¥æ•°      | æ¯æ­¥æ“ä½œ | æ€»æ“ä½œ         |
| -------- | --------- | -------- | -------------- |
| å½’çº¦     | logâ‚‚N     | N/2^k    | N-1            |
| åˆ†å‘     | logâ‚‚N - 1 | N/2^k    | N-1-logâ‚‚N      |
| **æ€»è®¡** |           |          | **2N-2-logâ‚‚N** |

å¯¹äº N=1024ï¼š

- Kogge-Stoneï¼š10240 æ¬¡æ“ä½œ
- Brent-Kungï¼š~2046 æ¬¡æ“ä½œ

**å·¥ä½œæ•ˆç‡æå‡ 5 å€ï¼**

### ä¸ºä»€ä¹ˆæ¯çº¿ç¨‹å¤„ç†ä¸¤ä¸ªå…ƒç´ ï¼Ÿ

```cuda
int i = 2 * blockIdx.x * blockDim.x + threadIdx.x;
```

å¦‚æœ Section æœ‰ 1024 ä¸ªå…ƒç´ ï¼Œåªéœ€è¦ 512 ä¸ªçº¿ç¨‹ã€‚æ¯çº¿ç¨‹åŠ è½½ä¸¤ä¸ªå…ƒç´ ï¼Œå‡å°‘äº†çº¿ç¨‹å¼€é”€ã€‚

## Kogge-Stone vs Brent-Kung

### å¯¹æ¯”

| æŒ‡æ ‡           | Kogge-Stone | Brent-Kung     |
| -------------- | ----------- | -------------- |
| æ€»æ“ä½œæ•°       | NÂ·logâ‚‚N     | 2N - 2 - logâ‚‚N |
| æ­¥æ•°           | logâ‚‚N       | 2Â·logâ‚‚N - 1    |
| å¹¶è¡Œåº¦ï¼ˆæ¯æ­¥ï¼‰ | N           | é€’å‡/é€’å¢      |
| æ§åˆ¶é€»è¾‘       | ç®€å•        | å¤æ‚           |
| å·¥ä½œæ•ˆç‡       | ä½          | é«˜ï¼ˆæ¥è¿‘ä¸²è¡Œï¼‰ |

### ç®—æ³•é€‰æ‹©ç­–ç•¥

| åœºæ™¯          | æ¨èç®—æ³•    | åŸå›              |
| ------------- | ----------- | ---------------- |
| å°æ•°ç»„ï¼ˆ<1Kï¼‰ | Kogge-Stone | ç®€å•ï¼Œæ­¥æ•°å°‘     |
| å¤§æ•°ç»„        | Brent-Kung  | å·¥ä½œé‡å°         |
| å¸¦å®½å—é™      | Kogge-Stone | æ›´å¤šå¹¶è¡Œéšè—å»¶è¿Ÿ |
| è®¡ç®—å—é™      | Brent-Kung  | æ€»æ“ä½œå°‘         |

å®é™…ä¸­ï¼Œæ··åˆç­–ç•¥æœ€å¸¸è§ï¼šå¤§éƒ¨åˆ†ç”¨ Brent-Kungï¼Œæœ€åå‡ å±‚ç”¨ Kogge-Stoneã€‚

## ä¸‰é˜¶æ®µåˆ†å±‚æ‰«æ

### é—®é¢˜ï¼šè¶…å‡ºå• Block

å½“æ•°æ®é‡è¶…è¿‡å…±äº«å†…å­˜å®¹é‡æ—¶ï¼Œéœ€è¦**å¤š Block åä½œ**ã€‚

### ä¸‰é˜¶æ®µç®—æ³•

**é˜¶æ®µ 1ï¼šBlock å†…æ‰«æ**

æ¯ä¸ª Block ç‹¬ç«‹æ‰«æè‡ªå·±çš„ Sectionï¼Œä¿å­˜æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆSection Sumï¼‰ã€‚

```
Block 0: [3,4,11,11]  â†’ sum[0] = 11
Block 1: [4,5,11,14]  â†’ sum[1] = 14
Block 2: [5,6,12,15]  â†’ sum[2] = 15
...
```

**é˜¶æ®µ 2ï¼šæ‰«æ Section Sums**

å¯¹æ‰€æœ‰ Block çš„ sum åšæ‰«æï¼š

```
sum: [11, 14, 15, ...]
æ‰«æå: [0, 11, 25, 40, ...]  // Exclusive
```

è¿™ç»™å‡ºäº†æ¯ä¸ª Block çš„"èµ·å§‹åç§»"ã€‚

**é˜¶æ®µ 3ï¼šåŠ ä¸Šåç§»**

æ¯ä¸ª Block çš„æ‰€æœ‰å…ƒç´ åŠ ä¸Šå¯¹åº”çš„åç§»ï¼š

```
Block 0: [3,4,11,11] + 0  â†’ [3,4,11,11]
Block 1: [4,5,11,14] + 11 â†’ [15,16,22,25]
Block 2: [5,6,12,15] + 25 â†’ [30,31,37,40]
...
```

### å®ç°

**Kernel 1ï¼šBlock å†…æ‰«æ**

```cuda
__global__ void scan_phase1(float *X, float *Y, float *S, int n) {
    __shared__ float XY[SECTION_SIZE];
    
    // Block å†…æ‰«æï¼ˆBrent-Kungï¼‰
    // ...
    
    // ä¿å­˜ Section Sum
    if (threadIdx.x == blockDim.x - 1) {
        S[blockIdx.x] = XY[SECTION_SIZE - 1];
    }
    
    // å†™å›
    // ...
}
```

**Kernel 2ï¼šæ‰«æ Section Sums**

```cuda
// é€šå¸¸åªæœ‰ä¸€ä¸ª Blockï¼Œå› ä¸º Section æ•°é‡ä¸å¤š
scan_single_block<<<1, numSections>>>(S, S, numSections);
```

**Kernel 3ï¼šåŠ åç§»**

```cuda
__global__ void scan_phase3(float *Y, float *S, int n) {
    int i = blockIdx.x * SECTION_SIZE + threadIdx.x;
    if (blockIdx.x > 0 && i < n) {
        Y[i] += S[blockIdx.x - 1];  // Exclusive æ‰«æçš„ç»“æœ
    }
}
```

### é€’å½’å¤„ç†

å¦‚æœ Section æ•°é‡ä¹Ÿå¾ˆå¤§ï¼Œå¯¹ S çš„æ‰«ææœ¬èº«éœ€è¦åˆ†å±‚ã€‚å½¢æˆ**é€’å½’ç»“æ„**ï¼š

```
Level 0: æ‰«æåŸå§‹æ•°æ® â†’ Section Sums
Level 1: æ‰«æ Section Sums â†’ Super Section Sums
Level 2: æ‰«æ Super Section Sums
...
Level K: å• Block å®Œæˆ

ç„¶åé€†å‘åŠ åç§»ï¼š
Level K â†’ Level K-1 â†’ ... â†’ Level 0
```

**å±‚æ•°**ï¼šlog(N/SECTION_SIZE)

## å•éæ‰«æï¼ˆSingle-Pass Scanï¼‰

### åŠ¨æœº

ä¸‰é˜¶æ®µæ‰«æéœ€è¦å¤šæ¬¡ Kernel å¯åŠ¨ï¼Œæœ‰å¼€é”€ã€‚èƒ½å¦ä¸€éå®Œæˆï¼Ÿ

### æ€è·¯

ç”¨**åŸå­æ“ä½œ + å†…å­˜æ ‡å¿—**å®ç° Block é—´é€šä¿¡ï¼š

1. æ¯ä¸ª Block å®Œæˆæ‰«æåï¼Œå‘å¸ƒè‡ªå·±çš„ Section Sum
2. ç­‰å¾…å‰ä¸€ä¸ª Block çš„ç»“æœ
3. åŠ ä¸Šå‰ç¼€å¹¶ç»§ç»­

### å®ç°

```cuda
__global__ void single_pass_scan(float *X, float *Y, float *flags, 
                                  float *sums, int n) {
    __shared__ float XY[SECTION_SIZE];
    __shared__ float prefix;
    
    int bid = blockIdx.x;
    
    // Phase 1: Block å†…æ‰«æ
    // ... æ ‡å‡† Brent-Kung ...
    
    // Phase 2: ç­‰å¾…å‰ä¸€ä¸ª Block
    if (threadIdx.x == 0) {
        // å‘å¸ƒè‡ªå·±çš„å’Œ
        sums[bid] = XY[SECTION_SIZE - 1];
        __threadfence();  // ç¡®ä¿å†™å…¥å¯¹å…¶ä»– Block å¯è§
        atomicExch(&flags[bid], 1);  // æ ‡è®°å®Œæˆ
        
        // ç­‰å¾…å‰ç¼€
        if (bid > 0) {
            // ç­‰å¾… Block bid-1
            while (atomicAdd(&flags[bid - 1], 0) == 0);
            __threadfence();
            
            // ç´¯åŠ æ‰€æœ‰å‰ç¼€ï¼ˆå¯ä¼˜åŒ–ä¸º Kogge-Stone é£æ ¼ï¼‰
            float pre = 0;
            for (int i = 0; i < bid; i++) {
                pre += sums[i];
            }
            prefix = pre;
        } else {
            prefix = 0;
        }
    }
    __syncthreads();
    
    // Phase 3: åŠ åç§»å¹¶å†™å›
    int i = bid * SECTION_SIZE + threadIdx.x;
    if (i < n) {
        Y[i] = XY[threadIdx.x] + prefix;
    }
}
```

### é—®é¢˜

**é¡ºåºä¾èµ–**ï¼šBlock å¿…é¡»æŒ‰é¡ºåºå®Œæˆï¼Œå¯èƒ½å¯¼è‡´**ä¸²è¡ŒåŒ–**ã€‚

**æ”¹è¿›**ï¼šä½¿ç”¨ **Decoupled Look-back**ï¼ˆåˆ†ç¦»å›æº¯ï¼‰ç®—æ³•ï¼Œæ¯ä¸ª Block åªæŸ¥çœ‹éƒ¨åˆ†å‰ç¼€ï¼Œé“¾å¼ä¼ æ’­ã€‚

## å·¥ä½œæ•ˆç‡çš„æœ¬è´¨

### æ—¶é—´ vs æ“ä½œ

**å¹¶è¡Œæ—¶é—´**ï¼šæ‰€æœ‰å¤„ç†å™¨åŒæ—¶å·¥ä½œéœ€è¦çš„æ—¶é—´æ­¥æ•°

**æ€»æ“ä½œæ•°**ï¼šæ‰€æœ‰å¤„ç†å™¨æ‰§è¡Œçš„æ“ä½œæ€»å’Œ

**å·¥ä½œæ•ˆç‡ = ä¸²è¡Œæ“ä½œæ•° / å¹¶è¡Œæ“ä½œæ•°**

| ç®—æ³•        | å¹¶è¡Œæ—¶é—´ | æ€»æ“ä½œ  | å·¥ä½œæ•ˆç‡ |
| ----------- | -------- | ------- | -------- |
| ä¸²è¡Œ        | N        | N       | 100%     |
| Kogge-Stone | log N    | NÂ·log N | 1/log N  |
| Brent-Kung  | 2Â·log N  | 2N      | ~50%     |

### ä½•æ—¶è¿½æ±‚å·¥ä½œæ•ˆç‡ï¼Ÿ

**å¤„ç†å™¨å……è¶³æ—¶**ï¼š

- æ“ä½œæ•°ä¸»å¯¼æ—¶é—´
- åº”è¯¥è¿½æ±‚å·¥ä½œæ•ˆç‡

**å¤„ç†å™¨ä¸è¶³æ—¶**ï¼š

- æ­¥æ•°ä¸»å¯¼æ—¶é—´
- å¯ä»¥ç‰ºç‰²å·¥ä½œæ•ˆç‡æ¢å–æ›´å°‘æ­¥æ•°

GPU é€šå¸¸å¤„ç†å™¨"è¶³å¤Ÿå¤š"ï¼Œæ‰€ä»¥å·¥ä½œæ•ˆç‡å¾ˆé‡è¦ã€‚

## å‰ç¼€å’Œçš„åº”ç”¨

### æµå‹ç¼©ï¼ˆStream Compactionï¼‰

ç­›é€‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼š

```
è¾“å…¥:    [3, 1, 7, 0, 4, 1, 6, 3]
æ¡ä»¶:    x > 2
æ ‡å¿—:    [1, 0, 1, 0, 1, 0, 1, 1]
å‰ç¼€å’Œ:  [0, 1, 1, 2, 2, 3, 3, 4]  // Exclusive
è¾“å‡ºä½ç½®: 0, -, 1, -, 2, -, 3, 4
è¾“å‡º:    [3, 7, 4, 6, 3]
```

**Exclusive å‰ç¼€å’Œç»™å‡ºæ¯ä¸ªæ»¡è¶³æ¡ä»¶å…ƒç´ çš„è¾“å‡ºä½ç½®ï¼**

```cuda
__global__ void compact(int *flags, int *positions, 
                        float *in, float *out, int n) {
    int i = blockIdx.x * blockDim.x + threadIdx.x;
    if (i < n && flags[i]) {
        out[positions[i]] = in[i];
    }
}
```

### åŸºæ•°æ’åº

æŒ‰ä½æ’åºï¼Œæ¯ä¸€ä½ç”¨å‰ç¼€å’Œç¡®å®šä½ç½®ï¼š

```
ç¬¬ 0 ä½ = 0 çš„å…ƒç´ : å‰ç¼€å’Œç¡®å®šä½ç½®
ç¬¬ 0 ä½ = 1 çš„å…ƒç´ : ç´§éšå…¶å
```

### åˆ†é…å·¥ä½œ

æ ¹æ®è´Ÿè½½åˆ†é…ä»»åŠ¡ï¼š

```
ä»»åŠ¡å¤§å°:  [5, 3, 8, 2, 4]
å‰ç¼€å’Œ:    [0, 5, 8, 16, 18]

çº¿ç¨‹ 7 åº”è¯¥å¤„ç†å“ªä¸ªä»»åŠ¡ï¼Ÿ
â†’ äºŒåˆ†æŸ¥æ‰¾å‰ç¼€å’Œæ•°ç»„
â†’ ä»»åŠ¡ 1ï¼ˆå› ä¸º 5 â‰¤ 7 < 8ï¼‰
```

## CUB åº“

### ä½¿ç”¨ CUB å®ç°æ‰«æ

```cuda
#include <cub/cub.cuh>

void scanWithCub(float *d_in, float *d_out, int n) {
    void *d_temp = nullptr;
    size_t temp_bytes = 0;
    
    // ç¡®å®šä¸´æ—¶å­˜å‚¨å¤§å°
    cub::DeviceScan::InclusiveSum(d_temp, temp_bytes, d_in, d_out, n);
    
    cudaMalloc(&d_temp, temp_bytes);
    
    // æ‰§è¡Œæ‰«æ
    cub::DeviceScan::InclusiveSum(d_temp, temp_bytes, d_in, d_out, n);
    
    cudaFree(d_temp);
}
```

### CUB æä¾›çš„æ‰«æ

| å‡½æ•°                        | åŠŸèƒ½         |
| --------------------------- | ------------ |
| `DeviceScan::InclusiveSum`  | åŒ…å«å¼æ±‚å’Œ   |
| `DeviceScan::ExclusiveSum`  | æ’é™¤å¼æ±‚å’Œ   |
| `DeviceScan::InclusiveScan` | åŒ…å«å¼è‡ªå®šä¹‰ |
| `DeviceScan::ExclusiveScan` | æ’é™¤å¼è‡ªå®šä¹‰ |

### è‡ªå®šä¹‰æ“ä½œ

```cuda
struct MaxOp {
    __device__ float operator()(float a, float b) {
        return (a > b) ? a : b;
    }
};

MaxOp max_op;
cub::DeviceScan::InclusiveScan(d_temp, temp_bytes, 
                                d_in, d_out, max_op, n);
```

## å°ç»“

ç¬¬åä¸€ç« æ·±å…¥è®²è§£å‰ç¼€å’Œï¼š

**ä¸¤ç§å˜ä½“**ï¼šInclusiveï¼ˆå«å½“å‰ï¼‰vs Exclusiveï¼ˆä¸å«å½“å‰ï¼‰ã€‚Exclusive çš„åº”ç”¨æ›´å¹¿ï¼Œç‰¹åˆ«æ˜¯ç¡®å®šè¾“å‡ºä½ç½®ã€‚

**Kogge-Stone**ï¼šç®€å•ç›´æ¥ï¼Œlog N æ­¥ï¼Œä½†å·¥ä½œé‡ NÂ·log Nï¼Œå·¥ä½œæ•ˆç‡ä½ã€‚

**Brent-Kung**ï¼šåˆ†å½’çº¦å’Œåˆ†å‘ä¸¤é˜¶æ®µï¼Œå·¥ä½œé‡ ~2Nï¼Œæ¥è¿‘ä¸²è¡Œã€‚æ­¥æ•°ç•¥å¤šä½†æ›´é«˜æ•ˆã€‚

**åˆ†å±‚æ‰«æ**ï¼šå¤§æ•°æ®éœ€è¦å¤š Block åä½œã€‚ä¸‰é˜¶æ®µï¼šBlock å†…æ‰«æ â†’ æ‰«æ Section Sums â†’ åŠ åç§»ã€‚å¯é€’å½’å¤„ç†è¶…å¤§æ•°æ®ã€‚

**å·¥ä½œæ•ˆç‡**ï¼šå¹¶è¡Œç®—æ³•çš„æ€»æ“ä½œæ•°ä¸åº”è¿œè¶…ä¸²è¡Œã€‚GPU å¤„ç†å™¨å¤šï¼Œå·¥ä½œæ•ˆç‡æ¯”æ­¥æ•°æ›´é‡è¦ã€‚

**æ ¸å¿ƒåº”ç”¨**ï¼šæµå‹ç¼©ã€åŸºæ•°æ’åºã€è´Ÿè½½åˆ†é…ã€‚å‰ç¼€å’ŒæŠŠ"è¾“å‡ºä½ç½®"é—®é¢˜å˜æˆå¹¶è¡Œå¯è§£ã€‚

å‰ç¼€å’Œæ˜¯å¹¶è¡Œè®¡ç®—çš„åŸºç¡€åŸè¯­ï¼Œç†è§£å®ƒå¯¹äºå®ç°å¤æ‚å¹¶è¡Œç®—æ³•è‡³å…³é‡è¦ã€‚ä¸‹ä¸€ç« å­¦ä¹ åˆå¹¶ï¼ˆMergeï¼‰â€”â€”å¦ä¸€ä¸ªé‡è¦çš„å¹¶è¡ŒåŸè¯­ã€‚

---

## ğŸš€ ä¸‹ä¸€æ­¥

---

## ğŸ“š å‚è€ƒèµ„æ–™

- PMPP ç¬¬å››ç‰ˆ Chapter 11
- [ç¬¬åä¸€ç« ï¼šå‰ç¼€å’Œ](https://smarter.xin/posts/a6fc4cf6/)

**å­¦ä¹ æ„‰å¿«ï¼** ğŸ“

---

> **æœ¬æ–‡ GitHub ä»“åº“**: [https://github.com/psmarter/PMPP-Learning](https://github.com/psmarter/PMPP-Learning)
